<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>GPS Tracker</title>
  <style>
    body { margin: 0; font-family: sans-serif; }
    #login, #principal { display: none; padding: 10px; }
    #mapa { height: 70vh; width: 100%; margin-top: 10px; border-radius: 12px; }
    input { padding: 8px; margin: 4px 0; width: 100%; max-width: 300px; }
    button { padding: 10px 20px; margin-top: 10px; border: none; border-radius: 8px; background: #4285f4; color: white; cursor: pointer; }
    button:hover { background: #3367d6; }
    #velocidade, #velocidadeMaxima { margin-top: 10px; font-size: 16px; }
  </style>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
</head>
<body>
  <div id="login">
    <h2>Login</h2>
    <input type="text" id="usuario" placeholder="Usuário">
    <input type="password" id="senha" placeholder="Senha">
    <button onclick="verificarLogin()">Entrar</button>
  </div>

  <div id="principal">
    <h2>Rastreamento GPS</h2>
    <div id="velocidade">Velocidade atual: 0 km/h</div>
    <div id="velocidadeMaxima"></div>
    <div id="mapa"></div>
    <button onclick="limparPercurso()">Limpar Percurso</button>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const usuarioValido = "cliente21@osga.com";
    const senhaValida = "13181leo";

    function verificarLogin() {
      const u = document.getElementById('usuario').value;
      const s = document.getElementById('senha').value;
      if (u === usuarioValido && s === senhaValida) {
        document.getElementById('login').style.display = 'none';
        document.getElementById('principal').style.display = 'block';
        iniciarMapa();
      } else {
        alert("Login inválido");
      }
    }

    let mapa, marcadorCelular, polylineCelular;
    let trilhaCelular = [];
    let velocidadePorRua = {};
    let ultimosPontos = [];

    const token = "lFB0OVz9myOpC5kTOw4nDcnxdjdx-TCY";
    const ipServidor = "45.181.56.47";
    const porta = "8080";

    async function obterRua(lat, lon) {
      const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`;
      try {
        const r = await fetch(url);
        const j = await r.json();
        return j.address.road || "Rua desconhecida";
      } catch {
        return "Rua desconhecida";
      }
    }

    async function registrarVelocidade(lat, lon, velocidade) {
      const rua = await obterRua(lat, lon);
      if (!velocidadePorRua[rua] || velocidade > velocidadePorRua[rua]) {
        velocidadePorRua[rua] = velocidade;
        exibirVelocidades();
      }
    }

    function exibirVelocidades() {
      const div = document.getElementById('velocidadeMaxima');
      div.innerHTML = "<strong>Velocidade máxima por rua:</strong><br>" +
        Object.entries(velocidadePorRua)
              .map(([rua, vel]) => `${rua}: ${vel.toFixed(1)} km/h`)
              .join("<br>");
    }

    function iniciarMapa() {
      mapa = L.map('mapa').setView([-23.5, -46.6], 15);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19
      }).addTo(mapa);

      const iconeCelular = L.icon({
        iconUrl: 'https://cdn-icons-png.flaticon.com/512/61/61112.png',
        iconSize: [32, 32],
        iconAnchor: [16, 16]
      });

      marcadorCelular = L.marker([0, 0], { icon: iconeCelular }).addTo(mapa);
      polylineCelular = L.polyline([], { color: 'blue', weight: 8, opacity: 0.6 }).addTo(mapa);

      navigator.geolocation.watchPosition(async pos => {
        const { latitude: lat, longitude: lon, speed, accuracy } = pos.coords;

        // Ignora localizações imprecisas
        if (accuracy > 50) return;

        // Aplica média móvel (últimos 3 pontos)
        ultimosPontos.push([lat, lon]);
        if (ultimosPontos.length > 3) ultimosPontos.shift();

        const mediaLat = ultimosPontos.reduce((s, p) => s + p[0], 0) / ultimosPontos.length;
        const mediaLon = ultimosPontos.reduce((s, p) => s + p[1], 0) / ultimosPontos.length;

        const vel = (speed || 0) * 3.6;
        document.getElementById('velocidade').innerText = `Velocidade atual: ${vel.toFixed(1)} km/h`;

        marcadorCelular.setLatLng([mediaLat, mediaLon]);
        trilhaCelular.push([mediaLat, mediaLon]);
        polylineCelular.setLatLngs(trilhaCelular);

        // Centraliza somente se o usuário estiver longe do centro atual
        const dist = mapa.distance(mapa.getCenter(), [mediaLat, mediaLon]);
        if (dist > 100) {
          mapa.setView([mediaLat, mediaLon]);
        }

        await registrarVelocidade(mediaLat, mediaLon, vel);

        fetch(`http://${ipServidor}:${porta}/${token}/update/V3?value=${mediaLat},${mediaLon}`);
        fetch(`http://${ipServidor}:${porta}/${token}/update/V4?value=${JSON.stringify(trilhaCelular)}`);
        fetch(`http://${ipServidor}:${porta}/${token}/update/V5?value=${JSON.stringify(velocidadePorRua)}`);
      }, error => {
        console.error("Erro ao obter localização:", error);
      }, {
        enableHighAccuracy: true,
        maximumAge: 1000,
        timeout: 5000
      });
    }

    function limparPercurso() {
      trilhaCelular = [];
      velocidadePorRua = {};
      ultimosPontos = [];
      polylineCelular.setLatLngs([]);
      document.getElementById('velocidadeMaxima').innerText = '';
    }

    // Login inicial
    document.getElementById('login').style.display = 'block';
  </script>
</body>
</html>       
